```php
/**
 * 内购订单验证
 * @return array|int
 */
public function actionInApple(){
    $receipt = Yii::$app->request->post('appleReceipt');     //IOS返回的加密数据
    $transactionId = Yii::$app->request->post('transactionId');      //商品交易号
    $url = 'https://buy.itunes.apple.com/verifyReceipt';     //正式验证地址
    //向apple服务器取得信息
    $verifyJson = ['receipt-data' => $receipt]; //IOS验证数据格式
    $data_string= json_encode($verifyJson);    //将数据转换为json字符串
    $res = self::curl_post_apple($url, $data_string);
    $data = json_decode($res, true);    //解析ios返回的数据
    //如果返回状态值为21007,请求ios的测试验证地址
    if(isset($data['status']) && $data['status']===21007){
        $url = 'https://sandbox.itunes.apple.com/verifyReceipt'; //测试验证地址
        $res = self::curl_post_apple($url, $post_string);
        $data = json_decode($res, true);
    }
    if(isset($data['status']) && $data['status'] === 0){
        foreach($data['receipt']['in_app'] as $item){
            //检测流水号是否存在
            if($transactionId != $item['transaction_id'] || Order::checkThirdNo($item['transaction_id'])){
            continue;
        }
 //获取商品信息

 $prodInfo = Order::getProductInfoOfApple($prodType, $item['product_id']);
 //UPDATE ORDER
 $orderNo =date('YmdHis').mt_rand(1000, 9999);
 $result = Order::callbackOrderInApp([
 'no' => $orderNo,
 'name' => '在ONCE中购买['.$prodInfo->name.']',
 'transaction_id' => $item['transaction_id'],
 'total_fee' => $prodInfo->price,
 'pay_status' => 1,
 'pay_time_end' => time(),
 'prod_type' => $prodType,
 'prod_id' => $prodInfo->id,
 'uid' => Yii::$app->getUser()->getId(),
 'time' => time(),
 'price' => $prodInfo->price,
 'pay_type' => Order::PAY_TYPE_INAPP,
 'fromUid' => $fromUid
 ]);
 Yii::info('更新苹果订单成功['.$item['transaction_id'].']['.Yii::$app->getUser()->getId().']', 'app\in-app');
 //TODO, 验证金额
 Yii::info('更新用户金币['.$item['transaction_id'].']['.Yii::$app->getUser()->getId().']', 'app\in-app');
 Yii::info('更新用户金币/会员');
 if($result){
 //处理用户信息
 if($prodType == Order::BUY_Dia){ //购买金币
 if(!DiaLog::BuyDia(Yii::$app->getUser()->getId(), $prodInfo->dia_count+$prodInfo->dia_largess, $orderNo)){
 Yii::error('购买完成处理金币失败'.$item['transaction_id'], 'app\in-app');
 continue;
 }
 }
 }
 }
 $uid = Yii::$app->getUser()->getId();
 UserInfo::updateBaseCache($uid);
 UserInfo::$data=null; //重置$data数据
 return parent::success('', ['userInfo' => UserInfo::transform($uid)]);
 }else{
 Yii::trace('内购验证失败');
 return parent::error(500,'内购验证失败');
 }
 }

 //通过curl请求ios服务器
 public static function curl_post_apple($url, $data_string){
     $curl_handle=curl_init();
     curl_setopt($curl_handle,CURLOPT_URL, $url);
     curl_setopt($curl_handle,CURLOPT_RETURNTRANSFER, true);
     curl_setopt($curl_handle,CURLOPT_HEADER, 0);
     curl_setopt($curl_handle,CURLOPT_POST, true);
     curl_setopt($curl_handle,CURLOPT_POSTFIELDS, $data_string);
     curl_setopt($curl_handle,CURLOPT_SSL_VERIFYHOST, 0);
     curl_setopt($curl_handle,CURLOPT_SSL_VERIFYPEER, 0);
     $response = curl_exec($curl_handle);
     curl_close($curl_handle);
     return $response;
 }
```